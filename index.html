<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FOCUS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --w: #ffffff;
            --b: #000000;
            --dim: #444444;
            --dimmer: #222222;
            --mid: #888888;
        }

        body {
            background: #000;
            color: #fff;
            font-family: 'Share Tech Mono', 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* CRT scanlines */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 100;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px,
                    rgba(255, 255, 255, 0.013) 2px, rgba(255, 255, 255, 0.013) 4px);
        }

        /* Vignette */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 99;
            pointer-events: none;
            background: radial-gradient(ellipse at center, transparent 45%, rgba(0, 0, 0, 0.85) 100%);
        }

        /* â”€â”€ Timer â”€â”€ */
        #timer-display {
            font-size: clamp(4.5rem, 18vw, 11rem);
            letter-spacing: 0.05em;
            line-height: 1;
            transition: text-shadow 0.4s;
            position: relative;
            user-select: none;
        }

        #timer-display.running {
            text-shadow: 0 0 24px rgba(255, 255, 255, 0.22), 0 0 70px rgba(255, 255, 255, 0.07);
        }

        /* Last 10s pulse */
        #timer-display.warning {
            animation: warn 0.45s ease-in-out infinite alternate;
        }

        @keyframes warn {
            from {
                opacity: 1
            }

            to {
                opacity: 0.35
            }
        }

        /* Finish flash */
        #timer-display.flash {
            animation: finish-flash 0.18s ease 3;
        }

        @keyframes finish-flash {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.05
            }
        }

        /* â”€â”€ Colon states via class â”€â”€ */
        #colon {
            display: inline-block;
        }

        #colon.blink {
            animation: blink 1s step-start infinite;
        }

        #colon.blink-fast {
            animation: blink 0.28s step-start infinite;
        }

        #colon.dimmed {
            opacity: 0.2;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.12
            }
        }

        /* â”€â”€ Mode badge â”€â”€ */
        #mode-badge {
            letter-spacing: 0.35em;
            font-size: 0.68rem;
            transition: color 0.4s;
            min-height: 1.1em;
        }

        /* â”€â”€ Transition countdown â”€â”€ */
        #trans-msg {
            font-size: 0.62rem;
            letter-spacing: 0.35em;
            color: var(--mid);
            min-height: 1.1em;
            text-align: center;
        }

        /* â”€â”€ Progress bar â”€â”€ */
        #prog-track {
            height: 1px;
            background: var(--dimmer);
            width: 100%;
            max-width: 440px;
        }

        #prog-fill {
            height: 1px;
            background: #fff;
            width: 0%;
            transition: width 0.6s linear;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.55);
        }

        /* â”€â”€ Session dots â”€â”€ */
        .dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--dimmer);
            border: 1px solid var(--dim);
            transition: background 0.35s, border-color 0.35s;
        }

        .dot.done {
            background: #fff;
            border-color: #fff;
        }

        .dot.active {
            background: transparent;
            border-color: #fff;
            animation: dot-pulse 0.9s ease infinite alternate;
        }

        @keyframes dot-pulse {
            from {
                border-color: #fff;
                opacity: 1
            }

            to {
                border-color: #444;
                opacity: 0.4
            }
        }

        /* â”€â”€ Control buttons â”€â”€ */
        .ctrl-btn {
            font-family: 'Share Tech Mono', monospace;
            letter-spacing: 0.25em;
            font-size: 0.82rem;
            border: 1px solid var(--dim);
            color: #fff;
            background: transparent;
            padding: 0.58rem 1.5rem;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s, color 0.15s, transform 0.1s;
        }

        .ctrl-btn:hover:not(:disabled) {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .ctrl-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .ctrl-btn:disabled {
            opacity: 0.18;
            cursor: not-allowed;
        }

        /* RESET confirm state */
        #reset-btn.confirming {
            border-color: #fff;
            color: #fff;
            animation: confirm-blink 0.55s ease infinite alternate;
        }

        @keyframes confirm-blink {
            from {
                opacity: 1
            }

            to {
                opacity: 0.4
            }
        }

        /* â”€â”€ Skip button â”€â”€ */
        #skip-btn {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.62rem;
            letter-spacing: 0.3em;
            color: var(--dim);
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
            padding: 0;
        }

        #skip-btn:hover {
            color: #fff;
        }

        /* â”€â”€ Icon toggle buttons â”€â”€ */
        .tog-btn {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.15em;
            color: var(--dim);
            background: none;
            border: 1px solid var(--dimmer);
            cursor: pointer;
            padding: 0.32rem 0.7rem;
            transition: color 0.2s, border-color 0.2s;
        }

        .tog-btn:hover {
            color: #888;
            border-color: #444;
        }

        .tog-btn.on {
            color: #fff;
            border-color: var(--dim);
        }

        /* â”€â”€ Edit settings button â”€â”€ */
        #edit-btn {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.62rem;
            letter-spacing: 0.3em;
            color: var(--dim);
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
            text-transform: uppercase;
        }

        #edit-btn:hover:not(:disabled) {
            color: #fff;
        }

        #edit-btn:disabled {
            color: var(--dimmer);
            cursor: not-allowed;
        }

        /* â”€â”€ Settings panel â”€â”€ */
        #settings-panel {
            border: 1px solid var(--dimmer);
            padding: 1.4rem 1.8rem;
            transition: opacity 0.25s, transform 0.25s;
            width: 100%;
        }

        #settings-panel.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }

        .s-label {
            font-size: 0.58rem;
            letter-spacing: 0.28em;
            color: var(--dim);
            text-transform: uppercase;
        }

        .s-input {
            font-family: 'Share Tech Mono', monospace;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--dim);
            color: #fff;
            font-size: 1.35rem;
            width: 3.4rem;
            text-align: center;
            outline: none;
            padding: 0.15rem 0;
            transition: border-color 0.2s;
        }

        .s-input:focus {
            border-bottom-color: #fff;
        }

        .s-input:disabled {
            color: var(--dimmer);
            border-bottom-color: var(--dimmer);
            cursor: not-allowed;
        }

        .s-input::-webkit-outer-spin-button,
        .s-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }

        .s-input[type=number] {
            -moz-appearance: textfield;
        }

        /* Toggle row */
        .tog-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.45rem 0;
            font-size: 0.62rem;
            letter-spacing: 0.22em;
            color: var(--mid);
            border-bottom: 1px solid var(--dimmer);
        }

        .tog-row:last-child {
            border-bottom: none;
        }

        .sw {
            width: 30px;
            height: 16px;
            border: 1px solid var(--dim);
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
            transition: border-color 0.2s;
            background: transparent;
        }

        .sw::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background: var(--dim);
            transition: transform 0.2s, background 0.2s;
        }

        .sw.on {
            border-color: #fff;
        }

        .sw.on::after {
            transform: translateX(14px);
            background: #fff;
        }

        /* Apply button */
        #apply-btn {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            letter-spacing: 0.22em;
            background: #fff;
            color: #000;
            border: none;
            padding: 0.48rem 1.3rem;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        #apply-btn:hover {
            opacity: 0.82;
        }

        /* Shortcuts */
        #shortcuts {
            font-size: 0.52rem;
            letter-spacing: 0.15em;
            color: #2a2a2a;
            text-align: center;
            line-height: 1.9;
        }

        /* Notification banner */
        #notif-banner {
            font-size: 0.58rem;
            letter-spacing: 0.22em;
            color: #444;
            border: 1px solid var(--dimmer);
            padding: 0.38rem 0.9rem;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
            text-align: center;
        }

        #notif-banner:hover {
            color: #888;
            border-color: var(--dim);
        }

        #notif-banner.hidden {
            display: none;
        }
    </style>
</head>

<body>

    <div class="flex flex-col items-center gap-5 w-full px-5" style="max-width:570px">

        <!-- NOTIFICATIONS BANNER -->
        <div id="notif-banner" onclick="requestNotifPermission()">
            [ ENABLE DESKTOP NOTIFICATIONS ]
        </div>

        <!-- MODE BADGE -->
        <div id="mode-badge" class="text-white">â— WORK SESSION</div>

        <!-- TIMER -->
        <div id="timer-display" class="font-mono text-white">
            <span id="mm">25</span><span id="colon">:</span><span id="ss">00</span>
        </div>

        <!-- TRANSITION MESSAGE -->
        <div id="trans-msg"></div>

        <!-- PROGRESS BAR -->
        <div id="prog-track">
            <div id="prog-fill"></div>
        </div>

        <!-- SESSION DOTS -->
        <div id="dots" class="flex gap-3"></div>

        <!-- SKIP -->
        <button id="skip-btn" style="display:none" onclick="skipPhase()">[ SKIP â†’ ]</button>

        <!-- MAIN CONTROLS -->
        <div class="flex gap-4">
            <button class="ctrl-btn" id="start-btn" onclick="startTimer()">START</button>
            <button class="ctrl-btn" id="pause-btn" onclick="pauseTimer()" disabled>PAUSE</button>
            <button class="ctrl-btn" id="reset-btn" onclick="confirmReset()">RESET</button>
        </div>

        <!-- SOUND / AMBIENT TOGGLES -->
        <div class="flex gap-3">
            <button class="tog-btn on" id="sound-btn" onclick="toggleSound()">â™ª BEEP</button>
            <button class="tog-btn" id="ambient-btn" onclick="toggleAmbient()">~ NOISE</button>
        </div>

        <!-- EDIT SETTINGS -->
        <button id="edit-btn" onclick="toggleSettings()">[ EDIT SETTINGS ]</button>

        <!-- SETTINGS PANEL -->
        <div id="settings-panel" class="hidden">

            <div class="flex gap-5 justify-center items-end mb-5 flex-wrap">
                <div class="flex flex-col items-center gap-2">
                    <span class="s-label">Work (min)</span>
                    <input class="s-input" id="inp-work" type="number" min="1" max="120" value="25" />
                </div>
                <div class="flex flex-col items-center gap-2">
                    <span class="s-label">Break (min)</span>
                    <input class="s-input" id="inp-break" type="number" min="1" max="60" value="5" />
                </div>
                <div class="flex flex-col items-center gap-2">
                    <span class="s-label">Long Break (min)</span>
                    <input class="s-input" id="inp-longbreak" type="number" min="1" max="60" value="15" />
                </div>
                <div class="flex flex-col items-center gap-2">
                    <span class="s-label">Sessions</span>
                    <input class="s-input" id="inp-sessions" type="number" min="1" max="8" value="4" />
                </div>
            </div>

            <div class="mb-5" style="border-top:1px solid #222; padding-top:0.9rem">
                <div class="tog-row">
                    <span>AUTO-START PHASES</span>
                    <div class="sw on" id="sw-autostart" onclick="toggleAutoStart()"></div>
                </div>
            </div>

            <div class="flex justify-center">
                <button id="apply-btn" onclick="applySettings()">APPLY</button>
            </div>
        </div>

        <!-- KEYBOARD SHORTCUTS HINT -->
        <div id="shortcuts">
            SPACE Â· START / PAUSE &nbsp;|&nbsp; S Â· SKIP &nbsp;|&nbsp; R Â· RESET
        </div>

    </div>

    <script>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CONFIG  (persisted to localStorage)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        const cfg = {
            workMin: 25, breakMin: 5, longBreakMin: 15,
            sessions: 4, sound: true, ambient: false, autoStart: true,
        };

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RUNTIME STATE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        let phase = 'work'; // 'work' | 'break' | 'longbreak'
        let secondsLeft = cfg.workMin * 60;
        let totalSeconds = cfg.workMin * 60;
        let isRunning = false;
        let isTransitioning = false;
        let interval = null;
        let sessionsDone = 0;
        let resetConfirm = false;
        let resetConfirmTid = null;
        let transTid = null;
        let settOpen = false;

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DOM REFS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        const mmEl = document.getElementById('mm');
        const ssEl = document.getElementById('ss');
        const colonEl = document.getElementById('colon');
        const dispEl = document.getElementById('timer-display');
        const badgeEl = document.getElementById('mode-badge');
        const transEl = document.getElementById('trans-msg');
        const progEl = document.getElementById('prog-fill');
        const dotsEl = document.getElementById('dots');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const skipBtn = document.getElementById('skip-btn');
        const editBtn = document.getElementById('edit-btn');
        const soundBtn = document.getElementById('sound-btn');
        const ambientBtn = document.getElementById('ambient-btn');
        const settPanel = document.getElementById('settings-panel');
        const swAuto = document.getElementById('sw-autostart');

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           AUDIO â€” single shared AudioContext
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        let _ctx = null, ambSrc = null, ambGain = null;

        function getCtx() {
            if (!_ctx) _ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (_ctx.state === 'suspended') _ctx.resume();
            return _ctx;
        }

        function beep() {
            if (!cfg.sound) return;
            try {
                const ctx = getCtx();
                [0, 0.28, 0.56].forEach(d => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = 'square';
                    const t = ctx.currentTime + d;
                    osc.frequency.setValueAtTime(1480, t);
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(0.32, t + 0.01);
                    g.gain.setValueAtTime(0.32, t + 0.11);
                    g.gain.linearRampToValueAtTime(0, t + 0.17);
                    osc.start(t); osc.stop(t + 0.2);
                });
            } catch (e) { }
        }

        function buildBrownNoise(ctx) {
            const n = ctx.sampleRate * 4;
            const buf = ctx.createBuffer(1, n, ctx.sampleRate);
            const dat = buf.getChannelData(0);
            let last = 0;
            for (let i = 0; i < n; i++) {
                const w = Math.random() * 2 - 1;
                dat[i] = (last + 0.02 * w) / 1.02;
                last = dat[i];
                dat[i] *= 3.5;
            }
            const src = ctx.createBufferSource();
            src.buffer = buf; src.loop = true;
            return src;
        }

        function startAmbient() {
            try {
                const ctx = getCtx();
                _killAmb();
                ambSrc = buildBrownNoise(ctx);
                ambGain = ctx.createGain();
                ambGain.gain.setValueAtTime(0.055, ctx.currentTime);
                ambSrc.connect(ambGain); ambGain.connect(ctx.destination);
                ambSrc.start();
            } catch (e) { }
        }

        function _killAmb() {
            if (ambSrc) { try { ambSrc.stop(); } catch (e) { } ambSrc = null; }
        }

        function stopAmbient() {
            if (!ambSrc || !ambGain || !_ctx) return;
            try {
                ambGain.gain.linearRampToValueAtTime(0, _ctx.currentTime + 0.35);
                const ref = ambSrc; ambSrc = null;
                setTimeout(() => { try { ref.stop(); } catch (e) { } }, 450);
            } catch (e) { _killAmb(); }
        }

        function toggleSound() {
            cfg.sound = !cfg.sound;
            soundBtn.classList.toggle('on', cfg.sound);
            saveCfg();
        }

        function toggleAmbient() {
            cfg.ambient = !cfg.ambient;
            ambientBtn.classList.toggle('on', cfg.ambient);
            if (cfg.ambient) startAmbient(); else stopAmbient();
            saveCfg();
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NOTIFICATIONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function checkNotifBanner() {
            if (!('Notification' in window) || Notification.permission !== 'default') {
                document.getElementById('notif-banner').classList.add('hidden');
            }
        }

        function requestNotifPermission() {
            if (!('Notification' in window)) return;
            Notification.requestPermission().then(() => checkNotifBanner());
        }

        function notify(title, body) {
            try {
                if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                    new Notification(title, { body });
                }
            } catch (e) { }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOCAL STORAGE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function saveCfg() {
            try { localStorage.setItem('focus_v3', JSON.stringify(cfg)); } catch (e) { }
        }

        function loadCfg() {
            try {
                const raw = localStorage.getItem('focus_v3');
                if (!raw) return;
                Object.assign(cfg, JSON.parse(raw));
                document.getElementById('inp-work').value = cfg.workMin;
                document.getElementById('inp-break').value = cfg.breakMin;
                document.getElementById('inp-longbreak').value = cfg.longBreakMin;
                document.getElementById('inp-sessions').value = cfg.sessions;
                soundBtn.classList.toggle('on', cfg.sound);
                ambientBtn.classList.toggle('on', cfg.ambient);
                swAuto.classList.toggle('on', cfg.autoStart);
                if (cfg.ambient) startAmbient();
            } catch (e) { }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RENDER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        const LABELS = { work: 'WORK', break: 'BREAK', longbreak: 'LONG BREAK' };

        function render() {
            const m = Math.floor(secondsLeft / 60);
            const s = secondsLeft % 60;
            const mStr = String(m).padStart(2, '0');
            const sStr = String(s).padStart(2, '0');
            mmEl.textContent = mStr;
            ssEl.textContent = sStr;
            document.title = `${mStr}:${sStr} Â· ${LABELS[phase]}`;

            const pct = ((totalSeconds - secondsLeft) / totalSeconds) * 100;
            progEl.style.width = pct + '%';

            // Last-10s warning
            if (isRunning && secondsLeft <= 10 && secondsLeft > 0) {
                dispEl.classList.add('warning');
                colonEl.className = 'blink-fast';
            } else if (isRunning) {
                dispEl.classList.remove('warning');
                colonEl.className = 'blink';
            }
        }

        function renderDots() {
            dotsEl.innerHTML = '';
            for (let i = 0; i < cfg.sessions; i++) {
                const d = document.createElement('div');
                if (i < sessionsDone) d.className = 'dot done';
                else if (i === sessionsDone && phase === 'work' && isRunning) d.className = 'dot active';
                else d.className = 'dot';
                dotsEl.appendChild(d);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BUTTON STATE HELPER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function setBtns(start, pause, skip) {
            startBtn.disabled = !start;
            pauseBtn.disabled = !pause;
            skipBtn.style.display = skip ? '' : 'none';
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TRANSITION COUNTDOWN  (fixes frozen 00:00 gap)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function runTransition(label, onDone) {
            isTransitioning = true;
            setBtns(false, false, true);
            editBtn.disabled = true;

            let n = 3;
            function tick() {
                transEl.textContent = `${label} IN ${n}...`;
                document.title = `${label} IN ${n}...`;
                if (n === 0) {
                    transEl.textContent = '';
                    isTransitioning = false;
                    onDone();
                } else {
                    n--;
                    transTid = setTimeout(tick, 1000);
                }
            }
            tick();
        }

        function cancelTransition() {
            clearTimeout(transTid);
            isTransitioning = false;
            transEl.textContent = '';
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CORE TIMER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function startTimer() {
            if (isRunning || isTransitioning) return;

            getCtx(); // init / resume AudioContext on user gesture

            // Clear pause visual state
            colonEl.className = 'blink';
            transEl.textContent = '';

            isRunning = true;
            dispEl.classList.add('running');
            dispEl.classList.remove('warning', 'flash');
            setBtns(false, true, true);
            editBtn.disabled = true;
            renderDots();

            interval = setInterval(() => {
                secondsLeft--;
                render();
                renderDots();

                if (secondsLeft <= 0) {
                    clearInterval(interval);
                    isRunning = false;
                    dispEl.classList.remove('running', 'warning');
                    colonEl.className = '';

                    dispEl.classList.add('flash');
                    setTimeout(() => dispEl.classList.remove('flash'), 600);
                    beep();
                    setTimeout(handlePhaseEnd, 700);
                }
            }, 1000);
        }

        function pauseTimer() {
            if (!isRunning) return;
            isRunning = false;
            clearInterval(interval);
            dispEl.classList.remove('running', 'warning');
            colonEl.className = 'dimmed';
            transEl.textContent = 'â€” PAUSED â€”';
            setBtns(true, false, true);
        }

        function skipPhase() {
            if (!isRunning && !isTransitioning) return;
            clearInterval(interval);
            cancelTransition();
            isRunning = false;
            dispEl.classList.remove('running', 'warning');
            colonEl.className = '';
            transEl.textContent = '';
            beep();
            setTimeout(handlePhaseEnd, 300);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PHASE TRANSITION LOGIC
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function handlePhaseEnd() {
            if (phase === 'work') {
                sessionsDone++;
                renderDots();

                if (sessionsDone >= cfg.sessions) {
                    // All sessions â†’ long break
                    phase = 'longbreak';
                    secondsLeft = cfg.longBreakMin * 60;
                    totalSeconds = cfg.longBreakMin * 60;
                    badgeEl.textContent = 'â— LONG BREAK';
                    badgeEl.style.color = '#888';
                    notify('ğŸ‰ All sessions complete!', `Enjoy your ${cfg.longBreakMin} min long break.`);
                } else {
                    phase = 'break';
                    secondsLeft = cfg.breakMin * 60;
                    totalSeconds = cfg.breakMin * 60;
                    badgeEl.textContent = 'â—‹ BREAK';
                    badgeEl.style.color = '#888';
                    notify('âœ“ Work session done!', `Take a ${cfg.breakMin} min break.`);
                }

            } else if (phase === 'break') {
                phase = 'work';
                secondsLeft = cfg.workMin * 60;
                totalSeconds = cfg.workMin * 60;
                badgeEl.textContent = 'â— WORK SESSION';
                badgeEl.style.color = '#fff';
                notify('â± Break over.', 'Time to focus!');

            } else if (phase === 'longbreak') {
                // Long break ends â†’ fresh cycle
                sessionsDone = 0;
                phase = 'work';
                secondsLeft = cfg.workMin * 60;
                totalSeconds = cfg.workMin * 60;
                badgeEl.textContent = 'â— WORK SESSION';
                badgeEl.style.color = '#fff';
                notify('âœ“ Long break done.', 'Starting a fresh set!');
                renderDots();
            }

            // Smooth progress bar reset â€” no hard jump
            progEl.style.transition = 'none';
            progEl.style.width = '0%';
            setTimeout(() => { progEl.style.transition = 'width 0.6s linear'; }, 40);

            render();

            if (cfg.autoStart) {
                runTransition(LABELS[phase], startTimer);
            } else {
                editBtn.disabled = false;
                setBtns(true, false, false);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET  (double-confirm when timer is active)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function confirmReset() {
            // If completely idle â†’ reset with no confirm needed
            if (!isRunning && !isTransitioning && secondsLeft === totalSeconds && sessionsDone === 0) {
                doReset(); return;
            }

            if (!resetConfirm) {
                resetConfirm = true;
                resetBtn.textContent = 'SURE?';
                resetBtn.classList.add('confirming');
                resetConfirmTid = setTimeout(() => {
                    resetConfirm = false;
                    resetBtn.textContent = 'RESET';
                    resetBtn.classList.remove('confirming');
                }, 3000);
            } else {
                clearTimeout(resetConfirmTid);
                resetConfirm = false;
                resetBtn.textContent = 'RESET';
                resetBtn.classList.remove('confirming');
                doReset();
            }
        }

        function doReset() {
            clearInterval(interval);
            cancelTransition();
            isRunning = false;
            phase = 'work';
            sessionsDone = 0;
            secondsLeft = cfg.workMin * 60;
            totalSeconds = cfg.workMin * 60;

            dispEl.classList.remove('running', 'warning', 'flash');
            colonEl.className = '';
            transEl.textContent = '';
            badgeEl.textContent = 'â— WORK SESSION';
            badgeEl.style.color = '#fff';

            progEl.style.transition = 'none';
            progEl.style.width = '0%';
            setTimeout(() => { progEl.style.transition = 'width 0.6s linear'; }, 40);

            setBtns(true, false, false);
            editBtn.disabled = false;
            renderDots();
            render();
            document.title = 'FOCUS';
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SETTINGS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function toggleSettings() {
            if (isRunning || isTransitioning) return; // locked while running
            settOpen = !settOpen;
            settPanel.classList.toggle('hidden', !settOpen);
        }

        function applySettings() {
            const clamp = (id, lo, hi) =>
                Math.min(Math.max(parseInt(document.getElementById(id).value) || lo, lo), hi);

            cfg.workMin = clamp('inp-work', 1, 120);
            cfg.breakMin = clamp('inp-break', 1, 60);
            cfg.longBreakMin = clamp('inp-longbreak', 1, 60);
            cfg.sessions = clamp('inp-sessions', 1, 8);

            document.getElementById('inp-work').value = cfg.workMin;
            document.getElementById('inp-break').value = cfg.breakMin;
            document.getElementById('inp-longbreak').value = cfg.longBreakMin;
            document.getElementById('inp-sessions').value = cfg.sessions;

            saveCfg();
            doReset();
            settOpen = false;
            settPanel.classList.add('hidden');
        }

        // Live clamp inputs while typing
        ['inp-work', 'inp-break', 'inp-longbreak', 'inp-sessions'].forEach(id => {
            document.getElementById(id).addEventListener('input', function () {
                const lo = parseInt(this.min), hi = parseInt(this.max), v = parseInt(this.value);
                if (!isNaN(v)) {
                    if (v < lo) this.value = lo;
                    if (v > hi) this.value = hi;
                }
            });
        });

        function toggleAutoStart() {
            cfg.autoStart = !cfg.autoStart;
            swAuto.classList.toggle('on', cfg.autoStart);
            saveCfg();
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           KEYBOARD SHORTCUTS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;

            if (e.code === 'Space') {
                e.preventDefault();
                if (isRunning) pauseTimer();
                else if (!isTransitioning) startTimer();
            }
            if (e.key.toLowerCase() === 's') {
                if (isRunning || isTransitioning) skipPhase();
            }
            if (e.key.toLowerCase() === 'r') {
                confirmReset();
            }
        });

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INIT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        loadCfg();
        secondsLeft = cfg.workMin * 60;
        totalSeconds = cfg.workMin * 60;
        checkNotifBanner();
        renderDots();
        render();
    </script>
</body>

</html>
